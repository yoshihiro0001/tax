# Project History

このファイルは、プロジェクトの進化履歴を記録するためのものです。

AIは作業前にこのファイルを読み、以下を把握すること：

・現在の状態
・過去の変更内容
・設計の流れ
・重要な判断履歴

構造の詳細は、実際のコード・フォルダを確認すること。

---

## 記録ルール

変更・修正・追加・設計判断を行った場合は、必ず追記する。

・古い内容は削除しない
・時系列で積み重ねる
・このファイルが唯一の進行記録とする

---

## 記録形式

【日付】

■種別
（機能追加 / 修正 / エラー対応 / UI変更 / 設計変更 / 構造変更 / パフォーマンス改善 / 方針変更）

■内容
何を実装・変更したか

■理由
なぜ行ったか

■対象
対象ファイル / 機能

■結果
完了 / 改善 / 保留 / 未完

---

## 記入例

【2026-02-17】

■種別
UI改善

■内容
レシート一覧の表示をカード形式に変更

■理由
スマホでの視認性向上

■対象
receipt_list.blade.php

■結果
完了

---

## 重要

・AIは過去履歴を考慮して判断すること
・既に対応済みの内容を再実装しないこと
・過去の設計判断を尊重すること
・改善や大規模変更を行った場合も必ず記録する

---

## 履歴

---

【2026-02-18】

■種別
構造変更 / パフォーマンス改善 / 機能追加

■内容
以下7項目を一括実施：

1. **DB最適化**
   - income/expenses/sessions/activity_logs/book_members に複合インデックス追加
   - 期限切れセッションの自動クリーンアップ（起動時 + 24時間ごと）
   - 重複マイグレーションコードを統合

2. **税金カテゴリ追加**
   - `tax_cost`（租税公課）: 消費税・印紙税・事業税等 → 経費に含む
   - `tax_profit`（利益課税）: 所得税・住民税・法人税等 → 経費に含めない（レポートでは別表示）
   - ダッシュボード・サマリー・税額シミュレーションの経費合計から tax_profit を除外
   - フロント/バックエンド両方にキーワード辞書追加

3. **レシート画像圧縮**
   - sharp導入。アップロード時に max 1200px / JPEG / quality 75 / EXIF削除
   - 原本は保存しない（圧縮後のみ保存）

4. **レポート期間指定**
   - 年度固定 → 任意期間（開始日〜終了日）で集計可能に
   - サマリーAPI に startDate/endDate パラメータ対応
   - 月別推移を YYYY-MM 形式に統一（期間をまたぐ集計に対応）

5. **経営分析機能**
   - レポート画面に「📊 分析」ボタン追加
   - 売上・経費・利益の KPI 表示
   - 利益率・経費率バー
   - カテゴリ別経費割合（経費内比率 + 売上比率）
   - 月別サマリーテーブル（売上/経費/利益/利益率）

6. **レシートZIPエクスポート**
   - archiver導入。`/api/export-receipts` エンドポイント追加
   - 任意期間指定でカテゴリ別フォルダ構成の ZIP 出力
   - ファイル名: `YYYY-MM-DD_金額_内容.jpg`
   - ZIP名: `Receipts_YYYY-MM-DD_YYYY-MM-DD.zip`

7. **UI改善**
   - レポートに期間選択バー（開始日・終了日）追加
   - 利益課税の経費内訳表示を別スタイル（黄色ボーダー + 「経費外」タグ）
   - カテゴリ別に売上比率パーセント表示

■理由
- DB肥大化とクエリ性能の先手対策
- 法人決算への対応（任意期間集計）
- 税金の正確な分類（コスト税 vs 利益課税）
- ストレージコスト最小化（画像圧縮）
- 経営判断を直感的に可能にするための分析機能
- 税理士提出・税務調査対応のためのレシートエクスポート

■対象
- server.js（DB・API・圧縮・ZIP）
- public/app.js（カテゴリ・レポート・分析・エクスポート）
- public/index.html（期間選択UI・分析セクション）
- public/style.css（分析・税金カテゴリ・期間バーのスタイル）
- package.json（sharp, archiver 追加）

■結果
完了

■設計判断メモ
- 税額シミュレーションは年度ベースを維持（税制が年度単位のため）
- サマリー・分析のみ任意期間対応
- tax_profit は expenses テーブルに保存するが、集計では除外するフィルタ方式を採用
- 画像圧縮は不可逆（原本非保存）= ストレージ最小化を最優先

---

【2026-02-18】

■種別
エラーチェック / コミット / プッシュ / デプロイ対応

■内容
- server.js・app.js の構文チェック（node --check）→ エラーなし
- sharp・archiver モジュールのロード確認 → OK
- 成功画面ボタン（「もう1枚撮る」「ホームへ」）テキスト確認 → HTML・CSS ともに正常（text あり）
- git add / commit / push → コミットハッシュ: 3475b64
- 本番デプロイ（bash deploy.sh）→ SSH公開鍵認証がCursorエージェント環境に存在しないため自動実行不可。ユーザーがターミナルで `bash deploy.sh` を手動実行する必要あり

■理由
- 大規模変更後のエラー確認・本番反映のため

■対象
- server.js, public/app.js, public/index.html, public/style.css, package.json

■結果
- コミット・プッシュ: 完了（3475b64 → 92f2d97 → fad4cca → 3750601）
- デプロイ: 完了（PM2 tax-tool online 確認済み）
- 本番URL: https://fashionhoteljoy.com/tax
- SSH公開鍵認証: 設定完了（ssh-copy-id root@fashionhoteljoy.com）→ 以降、AIが deploy.sh を自動実行可能

---

【2026-02-18】

■種別
バグ修正

■内容
レポート画面でエラー "Cannot read properties of undefined (reading 'totalComprehensiveTax')" を修正
- `t.comprehensiveTaxDetail.totalComprehensiveTax` → `t.comprehensiveTaxDetail?.totalComprehensiveTax` に変更（?.オプショナルチェーン）

■理由
旧サーバーの /api/tax-simulation レスポンスに comprehensiveTaxDetail が含まれていなかった場合に発生するTypeError。null チェックを追加して防御的に対処。

■対象
- public/app.js（853行目）

■結果
完了 / コミット: 9af9b7b / デプロイ済み

---

【2026-02-18】

■種別
重大バグ修正 / 機能追加 / デプロイ修正

■内容

1. **デプロイ先ディレクトリ修正（根本原因）**
   - deploy.sh のデプロイ先が `/var/www/tax-tool/` だったが、PM2は `/var/www/tax/` で動作
   - つまり前回までの全変更（税金カテゴリ、画像圧縮、分析機能等）が本番に反映されていなかった
   - deploy.sh を `/var/www/tax` + PM2プロセス名 `tax` に修正
   - 不要な PM2 `tax-tool` プロセスを削除

2. **loadReport の防御的コーディング**
   - `t.tax.*`, `t.currentBracket.*`, `t.comprehensiveTaxDetail.*` 等の全プロパティアクセスに `|| 0`, `|| {}` を追加
   - API レスポンスが不完全な場合でもクラッシュしない

3. **ギャラリーからの写真取り込み（複数選択対応）**
   - 「撮影」ボタンに加え「写真から」ボタンを追加
   - `capture` 属性なし + `multiple` 属性で端末のギャラリーから複数選択可能
   - 複数選択時は1枚ずつ順番にOCR→確認→保存のフローを実行

4. **キャッシュバスティング**
   - `app.js?v=20260218b`, `style.css?v=20260218b` でブラウザキャッシュを強制更新

5. **利益課税の計算フロー表示**
   - レポートの計算フローに「利益課税（経費外）」行を追加

■理由
- 以前のエージェントが `deploy.sh` のデプロイ先（`/var/www/tax-tool`）とPM2の実行先（`/var/www/tax`）が異なることに気づかず、全変更が本番に反映されていなかった
- フロントのエラーハンドリング不足でレポート画面がクラッシュ
- スマホではカメラだけでなく保存済み写真からの取り込みが必要

■対象
- deploy.sh（デプロイ先・PM2プロセス名修正）
- public/app.js（防御的コーディング・ギャラリー取込）
- public/index.html（ギャラリーUI・キャッシュバスティング・利益課税行）
- public/style.css（ギャラリーボタン・利益課税スタイル）

■結果
完了 / コミット: 5accf14 / デプロイ済み / 本番検証OK

■教訓
- PM2のプロセス名とデプロイ先ディレクトリの一致を必ず確認すること
- デプロイ後は必ず `head server.js` 等で本番のコードが更新されたか確認すること

---

【2026-02-18】

■種別
ドキュメント追加

■内容
運用エージェント向け作業手順書 `/ai_context/02_operations.md` を新規作成。
デプロイ・Git操作・エラーチェック・キャッシュバスティング・トラブルシューティングの全手順を文書化。

■理由
別エージェントがデプロイ作業を行った際、デプロイ先の誤りやPM2プロセス名の不一致に気づけなかった教訓から、
運用手順を明文化し、今後のオペレーションミスを防止する。

■対象
- ai_context/02_operations.md（新規）
- ai_context/01_history.md（履歴追記）

■結果
完了

---

【2026-02-18】

■種別
コミット / プッシュ / デプロイ

■内容
ai_context ドキュメント変更分のコミット・プッシュ・本番デプロイを実施。

- コミット: 7cf6ec8（Docs: 運用エージェント向け手順書を追加・憲法更新）
- push: origin/main へ反映
- bash deploy.sh → PM2 tax (id:4) online 確認
- 検証①〜⑤ 全通過（HTTP 200 / キャッシュ app.js?v=20260218b）

■理由
ai_context 3ファイル（00, 01, 02）の変更を本番に反映するため

■対象
- ai_context/00_constitution.md
- ai_context/01_history.md
- ai_context/02_operations.md

■結果
完了 / コミット: 7cf6ec8 / デプロイ済み

---

【2026-02-18】

■種別
UI/UX大幅改善 / 設計思想一新 / 憲法改定

■内容

1. **00_constitution.md 全面改定**
   - 最上位原則を「圧倒的直感操作・気持ちいいデザイン・無駄ゼロ」に変更
   - 画面ごとの設計思想を明文化（ホーム＝撮影メイン、レポート＝税金把握、設定＝管理）
   - やってはいけないことリストを明文化

2. **ホーム画面: カメラヒーロー復元**
   - 撮影ボタンを元の大きな1つのヒーローボタンに戻した
   - 「写真から」ボタンをテキスト無しの小さな丸アイコンに変更（カメラの下に配置）
   - 2カラムグリッド → 1カラム（撮影が主役）

3. **レポート画面: 大幅簡素化**
   - 冗長な期間選択バー（開始日〜終了日）を削除。年セレクターのみに統一
   - レシートZIPボタンをレポートから削除（設定画面に移動）
   - 税率テーブルカード完全削除（素人向けではない）
   - 節税提案を直感的なカード形式に改善（最大3件、金額を大きく表示）
   - 分析ボタンを下に配置（ピル型トグル）
   - 計算フローを簡素化（「事業所得」行削除、ラベル短縮）
   - カードタイトルの余分な絵文字・テキスト削減

4. **設定画面: レシート管理追加**
   - レシートセクション新設（期間指定 + ZIPダウンロード）
   - CSV取込の余分な説明テキスト削除

5. **CSS: プレミアムアニメーション強化**
   - カードのスタガーアニメーション追加（順次フェードイン）
   - 税額ヒーローの値にカウントアップ風アニメーション
   - ボトムナビのタップフィードバック改善（アクティブ時アイコンスケール）
   - 節税提案のカードデザイン刷新（flex横並び、節約額を大きく）
   - ギャラリーアイコンのインタラクション（タップ時にpri色に変化）
   - 税率ブラケットヒントのグラデーション背景

■理由
- ユーザーの本質的要望：「圧倒的直感操作で流れるように使えるサイト」
- 以前の変更は機能追加に重点を置きすぎ、操作性・デザインの統一感が不足していた
- 素人向けサイトに不要な専門情報（税率テーブル等）を表示していた
- 撮影ボタンの分割（カメラ/ギャラリーの2カラム）が直感性を損なっていた

■対象
- ai_context/00_constitution.md（全面改定）
- public/index.html（ホーム/レポート/設定の構造変更）
- public/style.css（アニメーション強化・デザイン刷新）
- public/app.js（ロジック簡素化・レシートエクスポート移動）

■結果
完了

■設計判断メモ
- レシートZIPは「年1回使う機能」→ 設定に格納（レポートから消す）
- 節税提案は最大3件のみ表示（情報過多を防ぐ）
- ギャラリーはアイコンのみ（今の人はアイコンだけでわかる）
- 期間選択は年セレクターで十分（法人決算対応は後日必要に応じて）
