# Project History

このファイルは、プロジェクトの進化履歴を記録するためのものです。

AIは作業前にこのファイルを読み、以下を把握すること：

・現在の状態
・過去の変更内容
・設計の流れ
・重要な判断履歴

構造の詳細は、実際のコード・フォルダを確認すること。

---

## 記録ルール

変更・修正・追加・設計判断を行った場合は、必ず追記する。

・古い内容は削除しない
・時系列で積み重ねる
・このファイルが唯一の進行記録とする

---

## 記録形式

【日付】

■種別
（機能追加 / 修正 / エラー対応 / UI変更 / 設計変更 / 構造変更 / パフォーマンス改善 / 方針変更）

■内容
何を実装・変更したか

■理由
なぜ行ったか

■対象
対象ファイル / 機能

■結果
完了 / 改善 / 保留 / 未完

---

## 記入例

【2026-02-17】

■種別
UI改善

■内容
レシート一覧の表示をカード形式に変更

■理由
スマホでの視認性向上

■対象
receipt_list.blade.php

■結果
完了

---

## 重要

・AIは過去履歴を考慮して判断すること
・既に対応済みの内容を再実装しないこと
・過去の設計判断を尊重すること
・改善や大規模変更を行った場合も必ず記録する

---

## 履歴

---

【2026-02-18】

■種別
構造変更 / パフォーマンス改善 / 機能追加

■内容
以下7項目を一括実施：

1. **DB最適化**
   - income/expenses/sessions/activity_logs/book_members に複合インデックス追加
   - 期限切れセッションの自動クリーンアップ（起動時 + 24時間ごと）
   - 重複マイグレーションコードを統合

2. **税金カテゴリ追加**
   - `tax_cost`（租税公課）: 消費税・印紙税・事業税等 → 経費に含む
   - `tax_profit`（利益課税）: 所得税・住民税・法人税等 → 経費に含めない（レポートでは別表示）
   - ダッシュボード・サマリー・税額シミュレーションの経費合計から tax_profit を除外
   - フロント/バックエンド両方にキーワード辞書追加

3. **レシート画像圧縮**
   - sharp導入。アップロード時に max 1200px / JPEG / quality 75 / EXIF削除
   - 原本は保存しない（圧縮後のみ保存）

4. **レポート期間指定**
   - 年度固定 → 任意期間（開始日〜終了日）で集計可能に
   - サマリーAPI に startDate/endDate パラメータ対応
   - 月別推移を YYYY-MM 形式に統一（期間をまたぐ集計に対応）

5. **経営分析機能**
   - レポート画面に「📊 分析」ボタン追加
   - 売上・経費・利益の KPI 表示
   - 利益率・経費率バー
   - カテゴリ別経費割合（経費内比率 + 売上比率）
   - 月別サマリーテーブル（売上/経費/利益/利益率）

6. **レシートZIPエクスポート**
   - archiver導入。`/api/export-receipts` エンドポイント追加
   - 任意期間指定でカテゴリ別フォルダ構成の ZIP 出力
   - ファイル名: `YYYY-MM-DD_金額_内容.jpg`
   - ZIP名: `Receipts_YYYY-MM-DD_YYYY-MM-DD.zip`

7. **UI改善**
   - レポートに期間選択バー（開始日・終了日）追加
   - 利益課税の経費内訳表示を別スタイル（黄色ボーダー + 「経費外」タグ）
   - カテゴリ別に売上比率パーセント表示

■理由
- DB肥大化とクエリ性能の先手対策
- 法人決算への対応（任意期間集計）
- 税金の正確な分類（コスト税 vs 利益課税）
- ストレージコスト最小化（画像圧縮）
- 経営判断を直感的に可能にするための分析機能
- 税理士提出・税務調査対応のためのレシートエクスポート

■対象
- server.js（DB・API・圧縮・ZIP）
- public/app.js（カテゴリ・レポート・分析・エクスポート）
- public/index.html（期間選択UI・分析セクション）
- public/style.css（分析・税金カテゴリ・期間バーのスタイル）
- package.json（sharp, archiver 追加）

■結果
完了

■設計判断メモ
- 税額シミュレーションは年度ベースを維持（税制が年度単位のため）
- サマリー・分析のみ任意期間対応
- tax_profit は expenses テーブルに保存するが、集計では除外するフィルタ方式を採用
- 画像圧縮は不可逆（原本非保存）= ストレージ最小化を最優先

---

【2026-02-18】

■種別
エラーチェック / コミット / プッシュ / デプロイ対応

■内容
- server.js・app.js の構文チェック（node --check）→ エラーなし
- sharp・archiver モジュールのロード確認 → OK
- 成功画面ボタン（「もう1枚撮る」「ホームへ」）テキスト確認 → HTML・CSS ともに正常（text あり）
- git add / commit / push → コミットハッシュ: 3475b64
- 本番デプロイ（bash deploy.sh）→ SSH公開鍵認証がCursorエージェント環境に存在しないため自動実行不可。ユーザーがターミナルで `bash deploy.sh` を手動実行する必要あり

■理由
- 大規模変更後のエラー確認・本番反映のため

■対象
- server.js, public/app.js, public/index.html, public/style.css, package.json

■結果
- コミット・プッシュ: 完了（3475b64 → 92f2d97 → fad4cca → 3750601）
- デプロイ: 完了（PM2 tax-tool online 確認済み）
- 本番URL: https://fashionhoteljoy.com/tax
- SSH公開鍵認証: 設定完了（ssh-copy-id root@fashionhoteljoy.com）→ 以降、AIが deploy.sh を自動実行可能

---

【2026-02-18】

■種別
バグ修正

■内容
レポート画面でエラー "Cannot read properties of undefined (reading 'totalComprehensiveTax')" を修正
- `t.comprehensiveTaxDetail.totalComprehensiveTax` → `t.comprehensiveTaxDetail?.totalComprehensiveTax` に変更（?.オプショナルチェーン）

■理由
旧サーバーの /api/tax-simulation レスポンスに comprehensiveTaxDetail が含まれていなかった場合に発生するTypeError。null チェックを追加して防御的に対処。

■対象
- public/app.js（853行目）

■結果
完了 / コミット: 9af9b7b / デプロイ済み

---

【2026-02-18】

■種別
重大バグ修正 / 機能追加 / デプロイ修正

■内容

1. **デプロイ先ディレクトリ修正（根本原因）**
   - deploy.sh のデプロイ先が `/var/www/tax-tool/` だったが、PM2は `/var/www/tax/` で動作
   - つまり前回までの全変更（税金カテゴリ、画像圧縮、分析機能等）が本番に反映されていなかった
   - deploy.sh を `/var/www/tax` + PM2プロセス名 `tax` に修正
   - 不要な PM2 `tax-tool` プロセスを削除

2. **loadReport の防御的コーディング**
   - `t.tax.*`, `t.currentBracket.*`, `t.comprehensiveTaxDetail.*` 等の全プロパティアクセスに `|| 0`, `|| {}` を追加
   - API レスポンスが不完全な場合でもクラッシュしない

3. **ギャラリーからの写真取り込み（複数選択対応）**
   - 「撮影」ボタンに加え「写真から」ボタンを追加
   - `capture` 属性なし + `multiple` 属性で端末のギャラリーから複数選択可能
   - 複数選択時は1枚ずつ順番にOCR→確認→保存のフローを実行

4. **キャッシュバスティング**
   - `app.js?v=20260218b`, `style.css?v=20260218b` でブラウザキャッシュを強制更新

5. **利益課税の計算フロー表示**
   - レポートの計算フローに「利益課税（経費外）」行を追加

■理由
- 以前のエージェントが `deploy.sh` のデプロイ先（`/var/www/tax-tool`）とPM2の実行先（`/var/www/tax`）が異なることに気づかず、全変更が本番に反映されていなかった
- フロントのエラーハンドリング不足でレポート画面がクラッシュ
- スマホではカメラだけでなく保存済み写真からの取り込みが必要

■対象
- deploy.sh（デプロイ先・PM2プロセス名修正）
- public/app.js（防御的コーディング・ギャラリー取込）
- public/index.html（ギャラリーUI・キャッシュバスティング・利益課税行）
- public/style.css（ギャラリーボタン・利益課税スタイル）

■結果
完了 / コミット: 5accf14 / デプロイ済み / 本番検証OK

■教訓
- PM2のプロセス名とデプロイ先ディレクトリの一致を必ず確認すること
- デプロイ後は必ず `head server.js` 等で本番のコードが更新されたか確認すること

---

【2026-02-18】

■種別
ドキュメント追加

■内容
運用エージェント向け作業手順書 `/ai_context/02_operations.md` を新規作成。
デプロイ・Git操作・エラーチェック・キャッシュバスティング・トラブルシューティングの全手順を文書化。

■理由
別エージェントがデプロイ作業を行った際、デプロイ先の誤りやPM2プロセス名の不一致に気づけなかった教訓から、
運用手順を明文化し、今後のオペレーションミスを防止する。

■対象
- ai_context/02_operations.md（新規）
- ai_context/01_history.md（履歴追記）

■結果
完了

---

【2026-02-18】

■種別
コミット / プッシュ / デプロイ

■内容
ai_context ドキュメント変更分のコミット・プッシュ・本番デプロイを実施。

- コミット: 7cf6ec8（Docs: 運用エージェント向け手順書を追加・憲法更新）
- push: origin/main へ反映
- bash deploy.sh → PM2 tax (id:4) online 確認
- 検証①〜⑤ 全通過（HTTP 200 / キャッシュ app.js?v=20260218b）

■理由
ai_context 3ファイル（00, 01, 02）の変更を本番に反映するため

■対象
- ai_context/00_constitution.md
- ai_context/01_history.md
- ai_context/02_operations.md

■結果
完了 / コミット: 7cf6ec8 / デプロイ済み

---

【2026-02-18】

■種別
UI/UX大幅改善 / 設計思想一新 / 憲法改定

■内容

1. **00_constitution.md 全面改定**
   - 最上位原則を「圧倒的直感操作・気持ちいいデザイン・無駄ゼロ」に変更
   - 画面ごとの設計思想を明文化（ホーム＝撮影メイン、レポート＝税金把握、設定＝管理）
   - やってはいけないことリストを明文化

2. **ホーム画面: カメラヒーロー復元**
   - 撮影ボタンを元の大きな1つのヒーローボタンに戻した
   - 「写真から」ボタンをテキスト無しの小さな丸アイコンに変更（カメラの下に配置）
   - 2カラムグリッド → 1カラム（撮影が主役）

3. **レポート画面: 大幅簡素化**
   - 冗長な期間選択バー（開始日〜終了日）を削除。年セレクターのみに統一
   - レシートZIPボタンをレポートから削除（設定画面に移動）
   - 税率テーブルカード完全削除（素人向けではない）
   - 節税提案を直感的なカード形式に改善（最大3件、金額を大きく表示）
   - 分析ボタンを下に配置（ピル型トグル）
   - 計算フローを簡素化（「事業所得」行削除、ラベル短縮）
   - カードタイトルの余分な絵文字・テキスト削減

4. **設定画面: レシート管理追加**
   - レシートセクション新設（期間指定 + ZIPダウンロード）
   - CSV取込の余分な説明テキスト削除

5. **CSS: プレミアムアニメーション強化**
   - カードのスタガーアニメーション追加（順次フェードイン）
   - 税額ヒーローの値にカウントアップ風アニメーション
   - ボトムナビのタップフィードバック改善（アクティブ時アイコンスケール）
   - 節税提案のカードデザイン刷新（flex横並び、節約額を大きく）
   - ギャラリーアイコンのインタラクション（タップ時にpri色に変化）
   - 税率ブラケットヒントのグラデーション背景

■理由
- ユーザーの本質的要望：「圧倒的直感操作で流れるように使えるサイト」
- 以前の変更は機能追加に重点を置きすぎ、操作性・デザインの統一感が不足していた
- 素人向けサイトに不要な専門情報（税率テーブル等）を表示していた
- 撮影ボタンの分割（カメラ/ギャラリーの2カラム）が直感性を損なっていた

■対象
- ai_context/00_constitution.md（全面改定）
- public/index.html（ホーム/レポート/設定の構造変更）
- public/style.css（アニメーション強化・デザイン刷新）
- public/app.js（ロジック簡素化・レシートエクスポート移動）

■結果
完了

■設計判断メモ
- レシートZIPは「年1回使う機能」→ 設定に格納（レポートから消す）
- 節税提案は最大3件のみ表示（情報過多を防ぐ）
- ギャラリーはアイコンのみ（今の人はアイコンだけでわかる）
- 期間選択は年セレクターで十分（法人決算対応は後日必要に応じて）

---

【2026-02-18】

■種別
コミット / プッシュ / デプロイ

■内容
UI/UX改善・憲法改定の変更分をコミット・プッシュ・本番デプロイ。

- 構文チェック（server.js / app.js）→ エラーなし
- キャッシュバスティング → v=20260218c 確認
- コミット: 80e1792
- push: origin/main へ反映
- bash deploy.sh → PM2 tax (id:4) online 確認
- 検証①〜⑤ 全通過（HTTP 200 / キャッシュ app.js?v=20260218c）

■理由
UI/UX大幅改善・設計思想一新変更を本番に反映するため

■対象
- ai_context/00_constitution.md
- ai_context/01_history.md
- public/app.js
- public/index.html
- public/style.css

■結果
完了 / コミット: 80e1792 / デプロイ済み

---

【2026-02-18】

■種別
バグ修正 / UI修正

■内容
スマホでの2つのレイアウト問題を修正：

1. **日付フィールドのはみ出し**
   - 収入・経費モーダルで `input[type=date]` がコンテナから右にはみ出す
   - `.fi` に `min-width: 0` を追加（iOS Safari の intrinsic 最小幅を上書き）
   - `.modal-sheet` / `.confirm-sheet` に `overflow-x: hidden` を追加

2. **横スクロールで余白が出る問題**
   - スマホで右スワイプすると画面外に余白が出てページが動く
   - `html, body` に `overflow-x: hidden` を追加
   - `.app-main` に `overflow-x: hidden` を追加

■理由
スマホ操作時のストレス解消。横スクロールで画面がずれると操作感が悪くなるため。

■対象
- public/style.css（overflow-x / min-width 追加）
- public/index.html（キャッシュバスティング: v=20260218d）

■結果
完了 / コミット: 80e0239 / デプロイ済み（HTTP 200 / style.css?v=20260218d 確認）

---

【2026-02-19】

■種別
機能追加（税計算エンジン大幅強化）

■内容
1. **国民健康保険料の自動算出** (server.js)
   - 医療分・支援金分・介護分を所得ベースで自動計算
   - 料率: 医療7.5%+均等割42,000円、支援2.5%+14,000円、介護2.0%+14,000円
   - 上限額（65万/22万/17万）適用
   - 10回払い（6月〜翌3月）のスケジュール自動生成

2. **個人事業税の自動算出** (server.js)
   - 事業所得から事業主控除290万円を差し引き、5%で算出
   - 290万以下は0円

3. **消費税の自動判定** (server.js)
   - 売上1,000万円超で簡易課税（サービス業みなし仕入率50%）を自動計算
   - 該当しない場合はスキップ

4. **医療費控除の閾値改善** (server.js)
   - 固定10万円 → min(10万円, 所得の5%) に変更（低所得者にも対応）
   - 控除上限200万円を適用

5. **支払スケジュール生成** (server.js)
   - 所得税（3月確定申告 + 予定納税7月/11月）
   - 住民税（4期: 6月/8月/10月/1月）
   - 国民健康保険（10期: 6月〜翌3月）
   - 個人事業税（2期: 8月/11月）
   - 消費税（3月）
   - 「いつ・何を・いくら」形式でソート

6. **実効税率の全税込み計算** (server.js)
   - 所得税率 + 住民税10% + 復興税2.1% + 国保所得割10% + 事業税5%
   - 節税tipsの計算にも全税種の影響を反映

7. **税負担サマリーバー** (index.html / style.css / app.js)
   - ヒーローを「年間税負担」に変更、実効税率表示
   - 税種別の棒グラフで視覚的に負担比率を表示

8. **支払カレンダーUI** (index.html / style.css / app.js)
   - タイムライン形式で月ごとにグルーピング
   - 税種ごとの色分け・アイコン表示
   - 合計額表示

9. **税額内訳の全税種表示** (app.js)
   - 従来の所得税+住民税に加え、国保・事業税・消費税を内訳に表示

10. **節税アドバイスの強化** (server.js / app.js)
    - 医療費控除の閾値までのアドバイス追加
    - 節約額にNHI・事業税の影響も含算
    - 表示数を5件に拡大

■理由
ユーザーが家計簿感覚で入力するだけで、プロの税理士が行う全税種の計算が裏側で走る状態を実現するため。
支払日と金額の見える化により「いつ・いくら必要か」を直感的に把握可能にする。

■対象
- server.js（calcNHI, calcBusinessTax, calcConsumptionTax, medicalDeductionThreshold, generatePaymentSchedule 関数追加 + tax-simulation応答拡張）
- public/index.html（税負担サマリー + 支払カレンダーUI追加 + キャッシュバスティング v=20260219a）
- public/style.css（tax-bar-*, payment-timeline スタイル追加）
- public/app.js（renderPaymentSchedule追加 + ヒーロー・税内訳・tips更新）

■結果
完了 / コミット: e957ad4 / デプロイ済み

---

【2026-02-19】

■種別
コミット / プッシュ / デプロイ

■内容
全税種計算・支払カレンダー・税負担サマリーの変更分をコミット・プッシュ・本番デプロイ。

- 構文チェック（server.js / app.js）→ エラーなし
- キャッシュバスティング → v=20260219a 確認
- コミット: e957ad4
- push: origin/main へ反映
- bash deploy.sh → PM2 tax (id:4) online 確認
- 検証①〜⑤ 全通過（HTTP 200 / キャッシュ app.js?v=20260219a）

■対象
- server.js, public/app.js, public/index.html, public/style.css

■結果
完了 / コミット: e957ad4 / デプロイ済み
