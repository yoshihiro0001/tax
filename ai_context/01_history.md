# Project History

このファイルは、プロジェクトの進化履歴を記録するためのものです。

AIは作業前にこのファイルを読み、以下を把握すること：

・現在の状態
・過去の変更内容
・設計の流れ
・重要な判断履歴

構造の詳細は、実際のコード・フォルダを確認すること。

---

## 記録ルール

変更・修正・追加・設計判断を行った場合は、必ず追記する。

・古い内容は削除しない
・時系列で積み重ねる
・このファイルが唯一の進行記録とする

---

## 記録形式

【日付】

■種別
（機能追加 / 修正 / エラー対応 / UI変更 / 設計変更 / 構造変更 / パフォーマンス改善 / 方針変更）

■内容
何を実装・変更したか

■理由
なぜ行ったか

■対象
対象ファイル / 機能

■結果
完了 / 改善 / 保留 / 未完

---

## 記入例

【2026-02-17】

■種別
UI改善

■内容
レシート一覧の表示をカード形式に変更

■理由
スマホでの視認性向上

■対象
receipt_list.blade.php

■結果
完了

---

## 重要

・AIは過去履歴を考慮して判断すること
・既に対応済みの内容を再実装しないこと
・過去の設計判断を尊重すること
・改善や大規模変更を行った場合も必ず記録する

---

## 履歴

---

【2026-02-18】

■種別
構造変更 / パフォーマンス改善 / 機能追加

■内容
以下7項目を一括実施：

1. **DB最適化**
   - income/expenses/sessions/activity_logs/book_members に複合インデックス追加
   - 期限切れセッションの自動クリーンアップ（起動時 + 24時間ごと）
   - 重複マイグレーションコードを統合

2. **税金カテゴリ追加**
   - `tax_cost`（租税公課）: 消費税・印紙税・事業税等 → 経費に含む
   - `tax_profit`（利益課税）: 所得税・住民税・法人税等 → 経費に含めない（レポートでは別表示）
   - ダッシュボード・サマリー・税額シミュレーションの経費合計から tax_profit を除外
   - フロント/バックエンド両方にキーワード辞書追加

3. **レシート画像圧縮**
   - sharp導入。アップロード時に max 1200px / JPEG / quality 75 / EXIF削除
   - 原本は保存しない（圧縮後のみ保存）

4. **レポート期間指定**
   - 年度固定 → 任意期間（開始日〜終了日）で集計可能に
   - サマリーAPI に startDate/endDate パラメータ対応
   - 月別推移を YYYY-MM 形式に統一（期間をまたぐ集計に対応）

5. **経営分析機能**
   - レポート画面に「📊 分析」ボタン追加
   - 売上・経費・利益の KPI 表示
   - 利益率・経費率バー
   - カテゴリ別経費割合（経費内比率 + 売上比率）
   - 月別サマリーテーブル（売上/経費/利益/利益率）

6. **レシートZIPエクスポート**
   - archiver導入。`/api/export-receipts` エンドポイント追加
   - 任意期間指定でカテゴリ別フォルダ構成の ZIP 出力
   - ファイル名: `YYYY-MM-DD_金額_内容.jpg`
   - ZIP名: `Receipts_YYYY-MM-DD_YYYY-MM-DD.zip`

7. **UI改善**
   - レポートに期間選択バー（開始日・終了日）追加
   - 利益課税の経費内訳表示を別スタイル（黄色ボーダー + 「経費外」タグ）
   - カテゴリ別に売上比率パーセント表示

■理由
- DB肥大化とクエリ性能の先手対策
- 法人決算への対応（任意期間集計）
- 税金の正確な分類（コスト税 vs 利益課税）
- ストレージコスト最小化（画像圧縮）
- 経営判断を直感的に可能にするための分析機能
- 税理士提出・税務調査対応のためのレシートエクスポート

■対象
- server.js（DB・API・圧縮・ZIP）
- public/app.js（カテゴリ・レポート・分析・エクスポート）
- public/index.html（期間選択UI・分析セクション）
- public/style.css（分析・税金カテゴリ・期間バーのスタイル）
- package.json（sharp, archiver 追加）

■結果
完了

■設計判断メモ
- 税額シミュレーションは年度ベースを維持（税制が年度単位のため）
- サマリー・分析のみ任意期間対応
- tax_profit は expenses テーブルに保存するが、集計では除外するフィルタ方式を採用
- 画像圧縮は不可逆（原本非保存）= ストレージ最小化を最優先

---

【2026-02-18】

■種別
エラーチェック / コミット / プッシュ / デプロイ対応

■内容
- server.js・app.js の構文チェック（node --check）→ エラーなし
- sharp・archiver モジュールのロード確認 → OK
- 成功画面ボタン（「もう1枚撮る」「ホームへ」）テキスト確認 → HTML・CSS ともに正常（text あり）
- git add / commit / push → コミットハッシュ: 3475b64
- 本番デプロイ（bash deploy.sh）→ SSH公開鍵認証がCursorエージェント環境に存在しないため自動実行不可。ユーザーがターミナルで `bash deploy.sh` を手動実行する必要あり

■理由
- 大規模変更後のエラー確認・本番反映のため

■対象
- server.js, public/app.js, public/index.html, public/style.css, package.json

■結果
- コミット・プッシュ: 完了（3475b64 → 92f2d97 → fad4cca → 3750601）
- デプロイ: 完了（PM2 tax-tool online 確認済み）
- 本番URL: https://fashionhoteljoy.com/tax
- SSH公開鍵認証: 設定完了（ssh-copy-id root@fashionhoteljoy.com）→ 以降、AIが deploy.sh を自動実行可能

---

【2026-02-18】

■種別
バグ修正

■内容
レポート画面でエラー "Cannot read properties of undefined (reading 'totalComprehensiveTax')" を修正
- `t.comprehensiveTaxDetail.totalComprehensiveTax` → `t.comprehensiveTaxDetail?.totalComprehensiveTax` に変更（?.オプショナルチェーン）

■理由
旧サーバーの /api/tax-simulation レスポンスに comprehensiveTaxDetail が含まれていなかった場合に発生するTypeError。null チェックを追加して防御的に対処。

■対象
- public/app.js（853行目）

■結果
完了 / コミット: 9af9b7b / デプロイ済み
