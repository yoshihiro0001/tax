<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Keihi - シンプル経費管理</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#6366f1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Noto+Sans+JP:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div id="toast-container"></div>

  <!-- ====== 認証画面 ====== -->
  <div id="auth-screen" class="screen">
    <div class="auth-card">
      <div class="auth-logo">K</div>
      <h1 class="auth-title">Keihi</h1>
      <p class="auth-sub">シンプルな経費管理</p>

      <form id="form-login" class="auth-form">
        <input type="email" id="login-email" placeholder="メールアドレス" required autocomplete="email">
        <input type="password" id="login-password" placeholder="パスワード" required autocomplete="current-password">
        <button type="submit" class="btn-auth">メールでログイン</button>
      </form>

      <form id="form-register" class="auth-form" style="display:none">
        <input type="text" id="reg-name" placeholder="お名前" required autocomplete="name">
        <input type="email" id="reg-email" placeholder="メールアドレス" required autocomplete="email">
        <input type="password" id="reg-password" placeholder="パスワード（6文字以上）" required autocomplete="new-password" minlength="6">
        <button type="submit" class="btn-auth">アカウント作成</button>
      </form>

      <!-- Google ログイン（メールフォームの下） -->
      <div id="google-signin-wrap" style="display:none">
        <div class="auth-divider"><span>または</span></div>
        <div id="google-signin-btn" class="google-btn-wrap"></div>
      </div>

      <p class="auth-toggle">
        <span id="auth-toggle-text">アカウントをお持ちでない方</span>
        <a href="#" id="auth-toggle-link">新規登録</a>
      </p>
    </div>
  </div>

  <!-- ====== メインアプリ ====== -->
  <div id="app-screen" class="screen" style="display:none">

    <!-- トップバー -->
    <header class="topbar">
      <button class="book-selector" id="book-selector-btn">
        <span id="cur-book-emoji">📒</span>
        <span id="cur-book-name">個人</span>
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" width="14" height="14"><polyline points="6 9 12 15 18 9"/></svg>
      </button>
      <div class="topbar-logo">K</div>
      <button class="user-btn" id="user-menu-btn"><span id="user-initial">K</span><img id="user-avatar-img" class="user-avatar-img" style="display:none" alt=""></button>
    </header>

    <!-- メインコンテンツ -->
    <main class="app-main">

      <!-- ===== ホーム ===== -->
      <section class="view active" id="view-home">
        <div class="home-summary">
          <div class="summary-item expense">
            <span class="summary-label">今月の経費</span>
            <span class="summary-value" id="home-expense">¥0</span>
          </div>
          <div class="summary-item income">
            <span class="summary-label">今月の収入</span>
            <span class="summary-value" id="home-income">¥0</span>
          </div>
        </div>

        <!-- レシート撮影ヒーロー -->
        <label class="capture-hero" for="receipt-input">
          <input type="file" id="receipt-input" accept="image/*" capture="environment" class="sr-only">
          <div class="capture-hero-glow"></div>
          <div class="capture-hero-inner">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>
            <span>レシートを撮影</span>
          </div>
        </label>

        <div class="sub-actions">
          <button class="btn-sub" id="btn-add-income">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
            収入
          </button>
          <button class="btn-sub" id="btn-add-manual">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
            手動経費
          </button>
        </div>

        <!-- 未取込データ（オーナー/管理者のみ表示） -->
        <div id="pending-section" style="display:none">
          <div class="section-head">
            <h2>📥 未取込データ <span class="pending-badge" id="pending-badge">0</span></h2>
            <button class="link-btn" id="btn-approve-all">すべて承認</button>
          </div>
          <div class="pending-list" id="pending-list"></div>
        </div>

        <div class="section-head">
          <h2>最近の取引</h2>
          <button class="link-btn" id="btn-view-all">すべて見る</button>
        </div>
        <div class="tx-list" id="home-transactions"></div>
        <div class="empty-msg" id="home-empty" style="display:none">まだ取引がありません</div>
      </section>

      <!-- ===== レポート ===== -->
      <section class="view" id="view-report">
        <div class="view-head">
          <h1>レポート</h1>
          <select id="report-year" class="sel-year"></select>
        </div>

        <!-- 税額サマリー（大きく表示） -->
        <div class="tax-hero" id="tax-hero">
          <div class="tax-hero-label">あなたの税金（推定）</div>
          <div class="tax-hero-val" id="tax-total">¥0</div>
          <div class="tax-hero-sub" id="tax-hero-sub"></div>
        </div>

        <!-- 収入区分別の課税方式 -->
        <div class="card" id="tax-by-type-card">
          <h3 class="card-title">📊 収入区分と課税方式</h3>
          <div id="tax-by-type"></div>
        </div>

        <!-- 総合課税の計算フロー -->
        <div class="card">
          <h3 class="card-title">📝 総合課税の計算</h3>
          <div class="tax-flow">
            <div class="tf-row tf-tappable" id="tf-income-row"><span>総合課税の収入</span><span class="tf-val income" id="rpt-income">¥0</span><span class="tf-arrow">›</span></div>
            <div class="tf-op">−</div>
            <div class="tf-row tf-tappable" id="tf-expense-row"><span>経費合計</span><span class="tf-val expense" id="rpt-expense">¥0</span><span class="tf-arrow">›</span></div>
            <div class="tf-op">−</div>
            <div class="tf-row"><span>減価償却費</span><span class="tf-val" id="rpt-depreciation">¥0</span></div>
            <div class="tf-eq"></div>
            <div class="tf-row bold"><span>事業所得</span><span class="tf-val" id="rpt-net-income">¥0</span></div>
            <div class="tf-op">−</div>
            <div class="tf-row"><span>控除合計</span><span class="tf-val" id="rpt-deductions">¥0</span></div>
            <div class="tf-eq thick"></div>
            <div class="tf-row bold"><span>課税所得</span><span class="tf-val primary" id="rpt-taxable">¥0</span></div>
          </div>
        </div>

        <!-- 税額の内訳 -->
        <div class="card">
          <h3 class="card-title">💰 税額の内訳</h3>
          <div id="tax-breakdown"></div>
        </div>

        <!-- 税率テーブル -->
        <div class="card" id="bracket-card">
          <h3 class="card-title">📋 所得税率テーブル</h3>
          <div id="bracket-table"></div>
        </div>

        <!-- 経費の節税効果 -->
        <div class="card" id="expense-impact-card" style="display:none">
          <h3 class="card-title">🧮 経費の節税効果</h3>
          <p class="card-desc" id="expense-impact-desc"></p>
          <div id="expense-impact"></div>
        </div>

        <!-- 節税ヒント -->
        <div class="card" id="tax-tips-card" style="display:none">
          <h3 class="card-title">💡 節税のヒント</h3>
          <div id="tax-tips"></div>
        </div>

        <!-- 控除の管理 -->
        <div class="card">
          <h3 class="card-title">控除の管理</h3>
          <div id="deduction-list"></div>
          <button class="btn-outline btn-sm" id="btn-add-deduction" style="margin-top:8px">＋ 控除を追加</button>
        </div>

        <!-- 減価償却 -->
        <div class="card">
          <h3 class="card-title">減価償却</h3>
          <div id="depreciation-list"></div>
          <button class="btn-outline btn-sm" id="btn-add-depreciation" style="margin-top:8px">＋ 資産を追加</button>
        </div>

        <!-- 収入内訳 -->
        <div class="card">
          <h3 class="card-title">収入内訳</h3>
          <div id="rpt-income-breakdown" class="rpt-breakdown-section"></div>
          <div class="rpt-bd-empty" id="rpt-income-empty" style="display:none">収入データがありません</div>
        </div>

        <!-- 経費内訳 -->
        <div class="card">
          <h3 class="card-title">経費内訳</h3>
          <div id="rpt-breakdown" class="rpt-breakdown-section"></div>
          <div class="rpt-bd-empty" id="rpt-expense-empty" style="display:none">経費データがありません</div>
        </div>

        <!-- 月別推移 -->
        <div class="card"><h3 class="card-title">月別推移</h3><div class="chart-wrap"><canvas id="chart-report"></canvas></div></div>

        <!-- AI -->
        <div class="card">
          <h3 class="card-title">AI相談用データ</h3>
          <button class="btn-primary btn-sm" id="btn-ai-gen">データを生成</button>
          <textarea id="ai-output" class="ai-textarea" readonly placeholder="「データを生成」を押してください"></textarea>
          <button class="btn-outline btn-sm" id="btn-ai-copy" style="display:none">コピー</button>
        </div>
      </section>

      <!-- ===== 設定 ===== -->
      <section class="view" id="view-settings">
        <div class="view-head"><h1>設定</h1></div>

        <!-- ▼ ユーザー用: データ概要（自分のデータだけ） -->
        <div class="card" id="user-overview">
          <h3 class="card-title">📊 あなたのデータ</h3>
          <div id="user-overview-loading" class="overview-loading"><div class="spinner"></div></div>
          <div id="user-overview-content" style="display:none"></div>
        </div>

        <div class="card">
          <h3 class="card-title">帳簿管理</h3>
          <p class="card-desc">個人・会社など用途別に帳簿を分けて管理できます</p>
          <div id="book-list" class="book-list"></div>
          <button class="btn-outline btn-full" id="btn-add-book">+ 帳簿を追加</button>
        </div>

        <div class="card">
          <h3 class="card-title">CSV取込</h3>
          <p class="card-desc">クレジットカード明細を現在の帳簿に取り込みます</p>
          <button class="btn-outline btn-full" id="btn-csv-open">CSVファイルを選択</button>
        </div>

        <div class="card">
          <h3 class="card-title">バックアップ</h3>
          <button class="btn-outline btn-full" id="btn-backup">データをエクスポート</button>
        </div>

        <!-- ユーザー問い合わせ -->
        <div class="card">
          <h3 class="card-title">💬 サポートに連絡</h3>
          <p class="card-desc">運営チームへの問い合わせ・要望はこちらから</p>
          <button class="btn-outline btn-full" id="btn-open-inquiry">問い合わせを送る</button>
          <div id="my-inquiries" style="margin-top:12px"></div>
        </div>

        <!-- ▼ 管理者専用エリア（admin のみ表示） -->
        <div id="admin-area" style="display:none">
          <div class="admin-divider"><span>🛡️ 運用管理パネル</span></div>
          <div id="admin-loading" class="overview-loading"><div class="spinner"></div></div>

          <!-- システムステータス -->
          <div class="admin-section" id="admin-system-section" style="display:none">
            <div class="admin-status-grid" id="admin-status-cards"></div>
          </div>

          <!-- 運用KPI -->
          <div class="admin-section" id="admin-kpi-section" style="display:none">
            <h3 class="admin-section-title">📊 運用メトリクス</h3>
            <div class="admin-kpi-grid" id="admin-kpi-cards"></div>
          </div>

          <!-- アクティブユーザー推移チャート -->
          <div class="card" id="admin-chart-section" style="display:none">
            <h3 class="card-title">📈 日別利用者の推移（14日間）</h3>
            <div class="admin-chart-wrap"><canvas id="admin-daily-chart"></canvas></div>
          </div>

          <!-- エラーログ -->
          <div class="card" id="admin-errors-section" style="display:none">
            <div class="admin-card-head">
              <h3 class="card-title">🚨 エラーログ</h3>
              <span class="admin-badge-count" id="admin-error-count">0</span>
            </div>
            <div id="admin-errors-list" class="admin-log-list"></div>
            <button class="btn-outline btn-sm" id="btn-clear-errors" style="margin-top:8px; display:none">ログをクリア</button>
          </div>

          <!-- 問い合わせ管理 -->
          <div class="card" id="admin-inquiries-section" style="display:none">
            <div class="admin-card-head">
              <h3 class="card-title">📩 問い合わせ</h3>
              <span class="admin-badge-count admin-badge-new" id="admin-inquiry-count">0</span>
            </div>
            <div id="admin-inquiries-list" class="admin-inquiry-list"></div>
          </div>

          <!-- 最近のアクティビティ -->
          <div class="card" id="admin-activity-section" style="display:none">
            <h3 class="card-title">⚡ 最近のアクティビティ</h3>
            <div id="admin-activity-list" class="admin-log-list"></div>
          </div>

          <!-- ユーザー管理 -->
          <div class="card" id="admin-users-section" style="display:none">
            <h3 class="card-title">👥 ユーザー管理</h3>
            <div id="admin-users-list"></div>
          </div>

          <!-- ランキング -->
          <div class="card" id="admin-ranking-section" style="display:none">
            <h3 class="card-title">🏆 ランキング</h3>
            <div id="admin-ranking"></div>
          </div>

          <!-- ストレージ -->
          <div class="card" id="admin-storage-section" style="display:none">
            <h3 class="card-title">💾 ストレージ</h3>
            <div id="admin-storage"></div>
          </div>
        </div>

        <button class="btn-danger btn-full" id="btn-logout">ログアウト</button>
      </section>

      <!-- ===== 取引一覧 (すべて見る) ===== -->
      <section class="view" id="view-history">
        <div class="view-head">
          <h1>取引履歴</h1>
          <button class="link-btn" id="btn-back-home">← ホーム</button>
        </div>
        <div class="filter-bar">
          <select id="hist-year" class="sel-sm"></select>
          <select id="hist-month" class="sel-sm">
            <option value="">全月</option>
            <option value="1">1月</option><option value="2">2月</option><option value="3">3月</option><option value="4">4月</option>
            <option value="5">5月</option><option value="6">6月</option><option value="7">7月</option><option value="8">8月</option>
            <option value="9">9月</option><option value="10">10月</option><option value="11">11月</option><option value="12">12月</option>
          </select>
          <select id="hist-type" class="sel-sm">
            <option value="">全種別</option><option value="income">収入</option><option value="expense">経費</option>
          </select>
        </div>
        <div class="tx-list" id="hist-transactions"></div>
        <div class="empty-msg" id="hist-empty" style="display:none">データがありません</div>
      </section>
    </main>

    <!-- ボトムナビ -->
    <nav class="bottom-nav">
      <button class="bnav-item active" data-view="home">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/></svg>
        <span>ホーム</span>
      </button>
      <button class="bnav-item" data-view="report">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>
        <span>レポート</span>
      </button>
      <button class="bnav-item" data-view="settings">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
        <span>設定</span>
      </button>
    </nav>
  </div>

  <!-- ====== オーバーレイ群 ====== -->

  <!-- OCRスキャン -->
  <div class="overlay" id="overlay-scanning" style="display:none">
    <div class="scan-wrap">
      <div class="scan-img-wrap"><img id="scan-img" alt=""><div class="scan-line"></div><div class="scan-corners"><span class="sc tl"></span><span class="sc tr"></span><span class="sc bl"></span><span class="sc br"></span></div></div>
      <div class="scan-info"><div class="scan-badge"><span class="scan-dot"></span><span id="scan-status">読み取り中...</span></div><div class="scan-progress"><div class="scan-progress-fill" id="scan-progress-fill"></div></div></div>
    </div>
  </div>

  <!-- 確認画面 -->
  <div class="overlay" id="overlay-confirm" style="display:none">
    <div class="confirm-sheet">
      <div class="confirm-head"><span class="confirm-badge">✨ 読み取り完了</span><h2>内容を確認</h2></div>
      <div class="confirm-body">
        <div class="confirm-thumb-wrap"><img id="confirm-img" alt=""></div>
        <div class="confirm-fields">
          <div class="cf" style="--i:0"><label>日付</label><input type="date" id="cf-date" class="cf-input"></div>
          <div class="cf" style="--i:1"><label>金額</label><div class="cf-amt"><span>¥</span><input type="number" id="cf-amount" class="cf-input cf-input-big" placeholder="0" inputmode="numeric"></div></div>
          <div class="cf" style="--i:2"><label>摘要</label><input type="text" id="cf-desc" class="cf-input" placeholder="店舗名・内容"></div>
          <div class="cf cf-cat-field" style="--i:3"><label>勘定科目</label><div class="cf-cats" id="cf-cats"></div></div>
        </div>
      </div>
      <div class="confirm-actions">
        <button class="btn-outline" id="btn-cf-retake">撮り直す</button>
        <button class="btn-save" id="btn-cf-save">保存する</button>
      </div>
    </div>
  </div>

  <!-- 成功 -->
  <div class="overlay" id="overlay-success" style="display:none">
    <div class="success-sheet">
      <div class="success-particles" id="success-particles"></div>
      <div class="success-check-wrap"><svg class="success-checkmark" viewBox="0 0 52 52"><circle class="success-circle" cx="26" cy="26" r="25" fill="none"/><path class="success-path" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8"/></svg></div>
      <h2 class="success-title">保存しました！</h2>
      <p class="success-summary" id="success-summary"></p>
      <div class="success-actions">
        <button class="btn-save" id="btn-ss-another">もう1枚撮る</button>
        <button class="btn-outline" id="btn-ss-home">ホームへ</button>
      </div>
    </div>
  </div>

  <!-- 収入入力モーダル -->
  <div class="overlay" id="overlay-income" style="display:none">
    <div class="modal-sheet">
      <div class="modal-head"><h3>収入を記録</h3><button class="btn-close" id="close-income">&times;</button></div>
      <form id="form-income" class="modal-form">
        <div class="fg"><label>日付</label><input type="date" id="inc-date" class="fi" required></div>
        <div class="fg"><label>金額</label><div class="fi-amt"><span>¥</span><input type="number" id="inc-amount" class="fi" placeholder="0" inputmode="numeric" required></div></div>
        <div class="fg"><label>入金方法</label><select id="inc-type" class="fi"><option value="振込">振込</option><option value="現金">現金</option><option value="その他">その他</option></select></div>
        <div class="fg"><label>所得区分</label><select id="inc-income-type" class="fi"><option value="business">事業所得</option><option value="salary">給与所得</option><option value="fx_stock">株・FX（分離課税）</option><option value="real_estate">不動産所得</option><option value="misc">その他</option></select></div>
        <div class="fg"><label>摘要</label><input type="text" id="inc-desc" class="fi" placeholder="例: ○○株式会社 報酬"></div>
        <button type="submit" class="btn-save btn-full">保存</button>
      </form>
    </div>
  </div>

  <!-- 手動経費モーダル -->
  <div class="overlay" id="overlay-manual" style="display:none">
    <div class="modal-sheet">
      <div class="modal-head"><h3>経費を手動入力</h3><button class="btn-close" id="close-manual">&times;</button></div>
      <form id="form-manual-expense" class="modal-form">
        <div class="fg"><label>日付</label><input type="date" id="me-date" class="fi" required></div>
        <div class="fg"><label>金額</label><div class="fi-amt"><span>¥</span><input type="number" id="me-amount" class="fi" placeholder="0" inputmode="numeric" required></div></div>
        <div class="fg"><label>摘要</label><input type="text" id="me-desc" class="fi" placeholder="例: 電車代"></div>
        <div class="fg"><label>勘定科目</label><div class="cat-grid" id="me-cats"></div></div>
        <button type="submit" class="btn-save btn-full">保存</button>
      </form>
    </div>
  </div>

  <!-- 編集・詳細モーダル -->
  <div class="overlay" id="overlay-edit" style="display:none">
    <div class="modal-sheet">
      <div class="modal-head"><h3 id="edit-title">取引を編集</h3><button class="btn-close" id="close-edit">&times;</button></div>
      <!-- 詳細情報エリア -->
      <div id="edit-detail-area" class="edit-detail-area" style="display:none">
        <div id="edit-receipt-preview" class="edit-receipt-preview" style="display:none">
          <img id="edit-receipt-img" alt="レシート">
        </div>
        <div class="edit-meta-grid" id="edit-meta-grid"></div>
      </div>
      <form id="form-edit" class="modal-form">
        <input type="hidden" id="edit-id"><input type="hidden" id="edit-kind">
        <div class="fg"><label>日付</label><input type="date" id="edit-date" class="fi" required></div>
        <div class="fg"><label>金額</label><div class="fi-amt"><span>¥</span><input type="number" id="edit-amount" class="fi" required></div></div>
        <div class="fg" id="edit-cat-group" style="display:none"><label>科目</label><select id="edit-category" class="fi"></select></div>
        <div class="fg" id="edit-income-type-group" style="display:none"><label>所得区分</label><select id="edit-income-type" class="fi"><option value="business">事業所得</option><option value="salary">給与所得</option><option value="fx_stock">株・FX（分離課税）</option><option value="real_estate">不動産所得</option><option value="misc">その他</option></select></div>
        <div class="fg"><label>摘要</label><input type="text" id="edit-desc" class="fi"></div>
        <div class="modal-btns"><button type="button" class="btn-danger" id="btn-edit-delete">削除</button><button type="submit" class="btn-save">保存</button></div>
      </form>
    </div>
  </div>

  <!-- 帳簿追加モーダル -->
  <div class="overlay" id="overlay-add-book" style="display:none">
    <div class="modal-sheet modal-sm">
      <div class="modal-head"><h3>帳簿を追加</h3><button class="btn-close" id="close-add-book">&times;</button></div>
      <form id="form-add-book" class="modal-form">
        <div class="fg"><label>帳簿名</label><input type="text" id="book-name" class="fi" placeholder="例: 会社A" required></div>
        <div class="fg"><label>アイコン</label>
          <div class="emoji-picker" id="emoji-picker">
            <span class="ep selected" data-e="📒">📒</span><span class="ep" data-e="👤">👤</span><span class="ep" data-e="🏢">🏢</span><span class="ep" data-e="💼">💼</span><span class="ep" data-e="🏠">🏠</span><span class="ep" data-e="🎨">🎨</span><span class="ep" data-e="💡">💡</span><span class="ep" data-e="🚀">🚀</span>
          </div>
        </div>
        <button type="submit" class="btn-save btn-full">作成</button>
      </form>
    </div>
  </div>

  <!-- 帳簿選択モーダル -->
  <div class="overlay" id="overlay-book-select" style="display:none">
    <div class="modal-sheet modal-sm">
      <div class="modal-head"><h3>帳簿を選択</h3><button class="btn-close" id="close-book-select">&times;</button></div>
      <div id="book-select-list" class="book-select-list"></div>
    </div>
  </div>

  <!-- CSV取込モーダル -->
  <div class="overlay" id="overlay-csv" style="display:none">
    <div class="modal-sheet modal-wide">
      <div class="modal-head"><h3 id="csv-title">CSV取込</h3><button class="btn-close" id="close-csv">&times;</button></div>
      <div id="csv-step-upload">
        <p class="card-desc">クレジットカード明細CSVを選択してください</p>
        <div class="file-area"><input type="file" id="csv-file" accept=".csv" class="sr-only"><label for="csv-file" class="file-label">CSVファイルを選択</label></div>
        <div class="csv-loading" id="csv-loading" style="display:none"><div class="spinner"></div><span>解析中...</span></div>
      </div>
      <div id="csv-step-preview" style="display:none">
        <div class="csv-head"><span id="csv-count"></span><button class="link-btn" id="csv-back">← 再選択</button></div>
        <div class="csv-table-wrap"><table class="csv-table"><thead><tr><th class="csv-th-ck"><input type="checkbox" id="csv-check-all" checked></th><th>日付</th><th>金額</th><th>摘要</th><th>科目</th></tr></thead><tbody id="csv-tbody"></tbody></table></div>
        <div class="csv-foot"><span id="csv-selected"></span><button class="btn-save" id="btn-csv-import">登録</button></div>
      </div>
    </div>
  </div>

  <!-- 問い合わせモーダル -->
  <div class="overlay" id="overlay-inquiry" style="display:none">
    <div class="modal-sheet">
      <div class="modal-head"><h3>問い合わせ</h3><button class="btn-close" id="close-inquiry">&times;</button></div>
      <form id="form-inquiry" class="modal-form">
        <div class="fg"><label>件名</label><input type="text" id="inq-subject" class="fi" placeholder="例: 機能リクエスト" required></div>
        <div class="fg"><label>メッセージ</label><textarea id="inq-message" class="fi" rows="5" placeholder="お気軽にどうぞ" required></textarea></div>
        <button type="submit" class="btn-save btn-full">送信</button>
      </form>
    </div>
  </div>

  <!-- 管理者問い合わせ返信モーダル -->
  <div class="overlay" id="overlay-admin-reply" style="display:none">
    <div class="modal-sheet">
      <div class="modal-head"><h3 id="admin-reply-title">返信</h3><button class="btn-close" id="close-admin-reply">&times;</button></div>
      <div id="admin-reply-detail" class="admin-reply-detail"></div>
      <form id="form-admin-reply" class="modal-form">
        <input type="hidden" id="reply-inq-id">
        <div class="fg"><label>返信メッセージ</label><textarea id="reply-message" class="fi" rows="4" placeholder="返信内容"></textarea></div>
        <div class="fg"><label>ステータス</label>
          <select id="reply-status" class="fi"><option value="replied">返信済み</option><option value="in_progress">対応中</option><option value="resolved">解決</option></select>
        </div>
        <button type="submit" class="btn-save btn-full">更新</button>
      </form>
    </div>
  </div>

  <!-- ユーザーメニュー -->
  <div class="overlay" id="overlay-user-menu" style="display:none">
    <div class="modal-sheet modal-sm">
      <div class="modal-head"><h3 id="user-menu-name">ユーザー</h3><button class="btn-close" id="close-user-menu">&times;</button></div>
      <p class="card-desc" id="user-menu-email"></p>
      <button class="btn-danger btn-full" id="btn-logout2" style="margin-top:12px">ログアウト</button>
    </div>
  </div>

  <!-- 収入/経費 一覧モーダル -->
  <div class="overlay" id="overlay-tx-list" style="display:none">
    <div class="modal-sheet modal-wide">
      <div class="modal-head"><h3 id="tx-list-title">一覧</h3><button class="btn-close" id="close-tx-list">&times;</button></div>
      <div id="tx-list-content" class="tx-list-modal-content"></div>
      <div class="tx-list-empty" id="tx-list-empty" style="display:none">データがありません</div>
    </div>
  </div>

  <!-- メンバー管理モーダル -->
  <div class="overlay" id="overlay-members" style="display:none">
    <div class="modal-sheet">
      <div class="modal-head"><h3 id="members-title">メンバー管理</h3><button class="btn-close" id="close-members">&times;</button></div>
      <div id="members-list"></div>
      <div class="member-add-section">
        <div class="member-add-title">メンバーを追加</div>
        <div class="fg"><input type="email" id="member-email" class="fi" placeholder="メールアドレスを入力"></div>
        <div class="member-perm-grid">
          <label class="member-perm-item"><input type="checkbox" id="mp-expense-input" checked><span>経費入力</span></label>
          <label class="member-perm-item"><input type="checkbox" id="mp-income-input"><span>収入入力</span></label>
          <label class="member-perm-item"><input type="checkbox" id="mp-income-view"><span>収入閲覧</span></label>
          <label class="member-perm-item"><input type="checkbox" id="mp-expense-view"><span>全経費閲覧</span></label>
        </div>
        <div class="member-role-row">
          <label>権限レベル</label>
          <select class="fi" id="mp-role">
            <option value="member">メンバー（入力のみ）</option>
            <option value="manager">管理者（メンバー管理可）</option>
          </select>
        </div>
        <button class="btn-save btn-full" id="btn-add-member">追加する</button>
      </div>
    </div>
  </div>

  <script src="app.js"></script>
</body>
</html>
